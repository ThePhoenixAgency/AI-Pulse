<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Connexion clé SMLIGHT à Zigbee2Mqtt sur Gladys (Full SSL/TLS) (MQTT et Z2M externe)</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.55; color: #e2e8f0; max-width: 800px; margin: 26px auto; padding: 0 18px; background: #0a0e27; }
  h1 { color: #00d9ff; margin-bottom: 0.35em; line-height: 1.22; font-size: clamp(1.45rem, 2.1vw, 1.95rem); font-weight: 700; }
  .metadata { color: #94a3b8; font-size: 0.86em; margin-bottom: 1.2em; border-bottom: 1px solid rgba(0,217,255,0.2); padding-bottom: 0.7em; }
  p { margin-bottom: 0.72em; line-height: 1.58; }
  img { max-width: 100%; width: auto !important; height: auto !important; object-fit: contain !important; border-radius: 8px; display: block; margin: 0.6em auto; }
  a { color: #00d9ff; }
  .article-elevator { position: fixed; right: 14px; bottom: 14px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
  .article-elevator-btn { width: 36px; height: 36px; border: 1px solid rgba(0,217,255,0.35); border-radius: 10px; background: rgba(10,14,39,0.88); color: #00d9ff; cursor: pointer; font-size: 16px; line-height: 1; }
  .article-elevator-btn:hover { background: rgba(10,14,39,1); }
  [id*="overlay"], [class*="overlay"], [id*="modal"], [class*="modal"], [id*="popup"], [class*="popup"],
  [id*="paywall"], [class*="paywall"], [id*="subscribe"], [class*="subscribe"], [id*="cookie"], [class*="cookie"],
  [id*="consent"], [class*="consent"], [id*="gdpr"], [class*="gdpr"], [role="dialog"], [aria-modal="true"] {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
  }
</style>
</head>
<body>
  <h1>Connexion clé SMLIGHT à Zigbee2Mqtt sur Gladys (Full SSL/TLS) (MQTT et Z2M externe)</h1>
  <div class="metadata">
    Source: Gladys Assistant (Forum) | Date: 2/22/2026 1:27:40 PM | <a href="https://community.gladysassistant.com/t/connexion-cle-smlight-a-zigbee2mqtt-sur-gladys-full-ssl-tls-mqtt-et-z2m-externe/10041" target="_blank" rel="noopener noreferrer">Lien</a> | Lang: FR
  </div>
  <div class="content">
    <p><p>Bonjour,</p>
<p>Comme promis, voici un tutoriel afin de connecter une clé SMLIGHT à Gladys via le réseau et non via USB car sinon on perd tout l’intérêt de cette clé en la branchant en USB <img src="https://gladys-assistant-community.b-cdn.net/images/emoji/apple/blush.png?v=15" title=":blush:" class="emoji" alt=":blush:" loading="lazy" width="20" height="20"></p>
<p>Gladys ne prenant en charge que le mode USB <a class="mention" href="https://community.gladysassistant.com/u/pierre-gilles">@pierre-gilles</a> arrête moi si je me trompe <img src="https://gladys-assistant-community.b-cdn.net/images/emoji/apple/upside_down_face.png?v=15" title=":upside_down_face:" class="emoji" alt=":upside_down_face:" loading="lazy" width="20" height="20">, je suis partie sur une installation avec un MQTT et Z2M externe à Gladys.<br>
Cela pourrait peut-être faire l’objet d’une demande de fonctionnalité, qu’en penses-tu <a class="mention" href="https://community.gladysassistant.com/u/pierre-gilles">@pierre-gilles</a> ?</p>
<p>Ici pour z2m en https j’utilise le port 443 mais pour éviter tout conflit si vous décider de tout installer sur la même machine il faudrait modifier par le port 4343 par exemple <img src="https://gladys-assistant-community.b-cdn.net/images/emoji/apple/slight_smile.png?v=15" title=":slight_smile:" class="emoji" alt=":slight_smile:" loading="lazy" width="20" height="20"></p>
<p>J’avais déjà fais un tuto complet sur HAOS à l’époque ou je l’utilisais que vous pouvez retrouver ici :</p><aside class="onebox discoursetopic" data-onebox-src="https://forum.hacf.fr/t/tuto-installer-haos-sur-proxmox-avec-z2m-et-mqtt-full-ssl-tls-lets-encrypt/24467"> <header class="source"> <img src="https://forum.hacf.fr/uploads/default/optimized/1X/0f657622af66788adb453e3b8dfb0089e7b9a05e_2_32x32.png" class="site-icon" alt="" width="32" height="32"> <a href="https://forum.hacf.fr/t/tuto-installer-haos-sur-proxmox-avec-z2m-et-mqtt-full-ssl-tls-lets-encrypt/24467" target="_blank" rel="noopener" title="09:58PM - 29 May 2025">Home Assistant Communauté Francophone – 29 May 25</a> </header> <article class="onebox-body"> <div class="aspect-image" style="--aspect-ratio:427/500;"><img src="https://forum.hacf.fr/uploads/default/original/3X/1/a/1a743a9b1634a75db234f97260c6dc961e5015f9.png" class="thumbnail" width="427" height="500"></div> <div class="title-wrapper"> <h3><a href="https://forum.hacf.fr/t/tuto-installer-haos-sur-proxmox-avec-z2m-et-mqtt-full-ssl-tls-lets-encrypt/24467" target="_blank" rel="noopener">[Tuto] Installer HAOS sur Proxmox avec Z2M et MQTT (Full SSL/TLS - Lets Encrypt)</a></h3> <div class="topic-category"> <span class="badge-wrapper bullet"> <span class="badge-category-bg" style="background-color: #3AB54A;"></span> <span class="badge-category clear-badge"> <span class="category-name">Home Assistant - Tutoriels &amp; Partages</span> </span> </span> <span class="badge-wrapper bullet"> <span class="badge-category-bg" style="background-color: #3AB54A;"></span> <span class="badge-category clear-badge"> <span class="category-name">Installation</span> </span> </span> <div class="topic-header-extra"> <div class="list-tags"> <div class="discourse-tags"> <svg class="fa d-icon d-icon-tag svg-icon svg-string"><use href="#tag"></use></svg> <span class="discourse-tag simple">tutoriel</span> </div> </div> </div> </div>
</div> <p>L’idée de ce tutoriel est de regrouper un peu toutes les infos que j’ai pu trouver pour l’installation de HAOS, Z2M et MQTT sur des VM séparés au sein de Proxmox et le tout en full SSL/TLS (Lets encrypt) sur ce type de machine : ...</p> <p> <span class="label1">Temps de lecture: 7 mins </span> <span class="label2">J'aime: 15 </span> </p> </article> <div class="onebox-metadata"> </div> <div style="clear: both"></div>
</aside> <p><strong>Installation Mosquitto (Mqtt)</strong></p>
<p>Installer une VM sous ubuntu 24.04, mettez la complétement à jour et lancez les commandes suivantes :</p>
<p>Pour installer docker :</p>
<pre><code class="lang-auto">curl -sSL https://get.docker.com/ | CHANNEL=stable sh
systemctl enable --now docker
</code></pre>
<p>Ajouter un utilisateur docker_mosquitto par exemple :</p>
<pre><code class="lang-auto">adduser docker_mosquitto
</code></pre>
<p>Récuperer son ID : (Ici 1002)</p>
<pre><code class="lang-auto">cat /etc/passwd [ grep docker_mosquitto
</code></pre>
<p><img src="https://gladys-assistant-community.b-cdn.net/uploads/default/original/3X/9/4/942810aad326887315921dd330e89709bbc9f45a.png" alt="image" data-base62-sha1="l8Evi9fiVZymo5kfNJDStmN34Ey" width="645" height="56"></p>
<p>Créer le dossier mosquitto dans /opt</p>
<pre><code class="lang-auto">mkdir /opt/mosquitto
</code></pre>
<p>Créer le fichier docker-compose.yml avec le contenu suivant : (Remplacer 1002 par les ID que l’on a récupéré juste avant)</p>
<pre><code class="lang-auto">services: mosquitto: image: eclipse-mosquitto:2.0.22 container_name: mosquitto restart: unless-stopped user: "1002:1002" ports: - "1883:1883" # MQTT - "8883:8883" # MQTTS (secure) - "9001:9001" # WebSockets volumes: - ./mosquitto/config:/mosquitto/config - ./mosquitto/data:/mosquitto/data - ./mosquitto/log:/mosquitto/log - /etc/localtime:/etc/localtime:ro - /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/chain.pem:/etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/chain.pem:ro - /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/privkey.pem:/etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/privkey.pem:ro - /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/cert.pem:/etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/cert.pem:ro
</code></pre>
<p>Créer un dossier mosquitto et les sous dossiers et appliquer les droits : (Celui-ci contiendra la configuration les datas et les logs)</p>
<pre><code class="lang-auto">mkdir /opt/mosquitto/mosquitto
mkdir /opt/mosquitto/mosquitto/data
mkdir /opt/mosquitto/mosquitto/config
mkdir /opt/mosquitto/mosquitto/log
touch mkdir /opt/mosquitto/mosquitto/log/mosquitto.log
chown -R 1002:1002 /opt/mosquitto/mosquitto
</code></pre>
<p>Créer le fichier de config dans /opt/mosquitto/mosquitto/config/mosquitto.conf</p>
<pre><code class="lang-auto">persistence true
persistence_location /mosquitto/data/ log_dest file /mosquitto/log/mosquitto.log listener 1883 localhost
allow_anonymous false
#password_file /mosquitto/config/passwd
tls_version tlsv1.3 listener 8883
certfile /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/cert.pem
cafile /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/chain.pem
keyfile /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/privkey.pem listener 9001
protocol websockets
certfile /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/cert.pem
cafile /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/chain.pem
keyfile /etc/letsencrypt/live/mqtt.xxx.local.srv-home.fr/privkey.pem
</code></pre>
<p>Activez le SSL : (A adapter en fonction du plugin que vous utilisez pour récupérer le certificat de votre nom de domaine) Ici il s’agit d’un exemple avec infomaniak</p>
<pre><code class="lang-auto">apt install certbot
apt install python3-pip
</code></pre>
<pre><code class="lang-auto">pip install certbot-dns-infomaniak
</code></pre>
<pre><code class="lang-auto">export INFOMANIAK_API_TOKEN=xxx
</code></pre>
<pre><code class="lang-auto">certbot certonly \ --authenticator dns-infomaniak \ --server https://acme-v02.api.letsencrypt.org/directory \ --agree-tos \ --rsa-key-size 4096 \ -d 'mqtt.xxx.local.srv-home.fr'
</code></pre>
<p>Par défaut, certbot installe un service qui renouvelle périodiquement ses certificats automatiquement. Pour ce faire, la commande doit connaître la clé API, sinon elle échouera silencieusement.</p>
<p>Afin d’activer le renouvellement automatique de vos certificats génériques, vous devrez modifier <code>/lib/systemd/system/certbot.service</code>. Ajoutez-y la ligne suivante dans <code>Service</code>, en remplaçant &lt;YOUR_API_TOKEN&gt;</p>
  </div>
  <div class="article-elevator" aria-label="Navigation article">
    <button class="article-elevator-btn" type="button" onclick="scrollToTop()">▲</button>
    <button class="article-elevator-btn" type="button" onclick="scrollToBottom()">▼</button>
  </div>
  <script>
    function stripBlockingPanels() {
      const selector = '[id*="overlay"], [class*="overlay"], [id*="modal"], [class*="modal"], [id*="popup"], [class*="popup"], [id*="paywall"], [class*="paywall"], [id*="subscribe"], [class*="subscribe"], [id*="cookie"], [class*="cookie"], [id*="consent"], [class*="consent"], [id*="gdpr"], [class*="gdpr"], [role="dialog"], [aria-modal="true"]';
      const textPattern = /\b(cookie|consent|gdpr|subscribe|subscription|paywall|abonnez[-\s]?vous|inscrivez[-\s]?vous|continue reading|continuez la lecture|connexion|login|register|inscription|abonnement|premium|subscriber|compte|account|se connecter|sign in|sign up)\b/i;
      document.querySelectorAll(selector).forEach((node) => node.remove());
      document.querySelectorAll('div, section, aside, header, footer, nav').forEach((node) => {
        const styleAttr = String(node.getAttribute('style') || '').toLowerCase();
        const classAndId = String(node.className || '').toLowerCase() + ' ' + String(node.id || '').toLowerCase();
        const text = String(node.textContent || '').slice(0, 1200);
        const hasKeyword = textPattern.test(classAndId) || textPattern.test(text);
        const looksFixed = /(position\s*:\s*(fixed|sticky)|inset\s*:|top\s*:|left\s*:|right\s*:|bottom\s*:)/.test(styleAttr);
        const hasPriority = /(z-index\s*:\s*[1-9]\d{1,}|backdrop-filter|overflow\s*:\s*hidden)/.test(styleAttr);
        if (hasKeyword && (looksFixed || hasPriority)) node.remove();
      });
    }
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'auto' });
    }
    function scrollToBottom() {
      window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'auto' });
    }
    window.addEventListener('message', (event) => {
      const data = event && event.data;
      if (!data || data.type !== 'AI_PULSE_SCROLL') return;
      if (data.direction === 'up' || data.direction === 'top') scrollToTop();
      if (data.direction === 'down' || data.direction === 'bottom') scrollToBottom();
    });
    stripBlockingPanels();
    setTimeout(stripBlockingPanels, 60);
    setTimeout(stripBlockingPanels, 220);
    setTimeout(stripBlockingPanels, 650);
  </script>
</body>
</html>