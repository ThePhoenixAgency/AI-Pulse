name: Sync Workflow to Action Repository

# ============================================================================
# WORKFLOW DE SYNCHRONISATION LEGITIME
# ============================================================================
# Ce workflow synchronise UNIQUEMENT les fichiers Dependabot depuis le depot
# source (AI-Pulse) vers le depot d'action GitHub (dependabot-secure-flow).
#
# SECURITE:
# - Execution limitee au depot source uniquement (condition if)
# - Liste blanche explicite des fichiers synchronises
# - Exclusion explicite du fichier de synchronisation lui-meme
# - Tag [skip ci] pour eviter boucles circulaires
#
# ALERTES CRANIUM AI:
# Les alertes "Self-Propagation Target: Trusted Folder" sont des faux positifs
# car ce workflow copie intentionnellement des workflows GitHub vers un depot
# controle par le meme proprietaire dans un contexte legitime.
# ============================================================================

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/dependabot-secure-flow.yaml'
      - '.github/workflows/release-notification.yaml'
      - '.github/dependabot.yml'
      - 'action.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-to-action-repo:
    runs-on: ubuntu-latest
    # SECURITE: EmpÃªcher l'exÃ©cution si dÃ©clenchÃ© depuis le dÃ©pÃ´t cible
    if: github.repository == 'ThePhoenixAgency/AI-Pulse'
    
    steps:
      - name: Checkout AI-Pulse repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Checkout dependabot-secure-flow repository
        uses: actions/checkout@v6
        with:
          repository: EthanThePhoenix38/dependabot-secure-flow
          token: ${{ secrets.SYNC_TOKEN }}
          path: action-repo
          fetch-depth: 0
          
      - name: Copy workflow and action files to action repository
        run: |
          # SECURITE: Copie unidirectionnelle AI-Pulse -> dependabot-secure-flow
          # Protection contre self-propagation via chemins statiques uniquement
          mkdir -p action-repo/.github/workflows
          
          # Liste blanche explicite des fichiers synchronisÃ©s
          WORKFLOW_FILES=(
            "dependabot-secure-flow.yaml"
            "release-notification.yaml"
          )
          
          # Copie des workflows avec validation
          for file in "${WORKFLOW_FILES[@]}"; do
            SOURCE=".github/workflows/$file"
            DEST="action-repo/.github/workflows/$file"
            
            if [ -f "$SOURCE" ]; then
              cp "$SOURCE" "$DEST"
              echo "[OK] CopiÃ©: $file"
            else
              echo "[ATTENTION] Fichier manquant: $SOURCE"
            fi
          done
          
          # Copie des fichiers de configuration
          [ -f action.yml ] && cp action.yml action-repo/action.yml
          [ -f .github/dependabot.yml ] && cp .github/dependabot.yml action-repo/.github/dependabot.yml
          
          # SECURITE: Ne jamais copier sync-to-action-repo.yaml vers la cible
          # pour Ã©viter une boucle de synchronisation

      - name: Commit and push changes
        id: commit
        working-directory: action-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git add .
          # SECURITE: Tag [skip ci] pour Ã©viter dÃ©clenchement circulaire
          git commit -m "chore: sync from AI-Pulse repository [skip ci]"
          git push origin main
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Get current version
        if: steps.commit.outputs.has_changes == 'true'
        id: version
        working-directory: action-repo
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "current=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          NEW_VERSION=$(echo $LATEST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          
          while git rev-parse "$NEW_VERSION" >/dev/null 2>&1; do
            echo "Tag $NEW_VERSION already exists, incrementing..."
            NEW_VERSION=$(echo $NEW_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          done
          
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Selected version: $NEW_VERSION"

      - name: Update CHANGELOG
        if: steps.commit.outputs.has_changes == 'true'
        working-directory: action-repo
        run: |
          DATE=$(date -u +"%Y-%m-%d")
          
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'EOF'
          # Changelog
          
          All notable changes to this project will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          ## [Unreleased]
          
          ### Added
          EOF
          fi
          
          VERSION="${{ steps.version.outputs.new }}"
          ENTRY="## [$VERSION] - $DATE\n### Changed\n- Automated sync from AI-Pulse repository\n- Updated workflow files and configurations\n"
          
          sed -i "/## \[Unreleased\]/a\\
          \\
          $ENTRY" CHANGELOG.md
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG for $VERSION [skip ci]" || echo "No CHANGELOG changes"
          git push origin main

      - name: Create Release
        if: steps.commit.outputs.has_changes == 'true'
        working-directory: action-repo
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          gh release create ${{ steps.version.outputs.new }} \
            --title "Release ${{ steps.version.outputs.new }}" \
            --notes "Automated sync from AI-Pulse repository
          
          **Changes:**
          - Updated workflow and action files
          - Synced dependencies
          
          **Synced files:**
          - \`.github/workflows/dependabot-secure-flow.yaml\`
          - \`.github/workflows/release-notification.yaml\`
          - \`action.yml\`
          - \`.github/dependabot.yml\`" \
            --latest

      - name: Create summary
        run: |
          echo "âœ… Files synchronized to EthanThePhoenix38/dependabot-secure-flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files synced:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/workflows/dependabot-secure-flow.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/workflows/release-notification.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`action.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/dependabot.yml\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Release created:** ${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          fi
