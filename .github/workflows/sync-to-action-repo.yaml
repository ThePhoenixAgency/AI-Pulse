name: Sync Workflow to Action Repository

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/dependabot-secure-flow.yaml'
      - '.github/workflows/release-notification.yaml'
      - '.github/dependabot.yml'
      - 'action.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-to-action-repo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout AI-Pulse repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout dependabot-secure-flow repository
        uses: actions/checkout@v4
        with:
          repository: EthanThePhoenix38/dependabot-secure-flow
          token: ${{ secrets.SYNC_TOKEN }}
          path: action-repo
          fetch-depth: 1

      - name: Copy workflow and action files to action repository
        run: |
          mkdir -p action-repo/.github/workflows
          
          # Copy workflow files
          cp .github/workflows/dependabot-secure-flow.yaml action-repo/.github/workflows/dependabot-secure-flow.yaml
          cp .github/workflows/release-notification.yaml action-repo/.github/workflows/release-notification.yaml
          
          # Copy action definition
          if [ -f action.yml ]; then
            cp action.yml action-repo/action.yml
          fi
          
          # Copy dependabot config
          if [ -f .github/dependabot.yml ]; then
            cp .github/dependabot.yml action-repo/.github/dependabot.yml
          fi

      - name: Commit and push changes
        id: commit
        working-directory: action-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          git add .
          git commit -m "chore: sync from AI-Pulse repository"
          git push origin main
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Get current version
        if: steps.commit.outputs.has_changes == 'true'
        id: version
        working-directory: action-repo
        run: |
          # Get latest tag or default to v1.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "current=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # Increment patch version (v1.0.0 -> v1.0.1)
          NEW_VERSION=$(echo $LATEST_TAG | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          
          # Check if the new version tag already exists and increment until we find an available one
          while git rev-parse "$NEW_VERSION" >/dev/null 2>&1; do
            echo "Tag $NEW_VERSION already exists, incrementing..."
            NEW_VERSION=$(echo $NEW_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
          done
          
          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Selected version: $NEW_VERSION"

      - name: Update CHANGELOG
        if: steps.commit.outputs.has_changes == 'true'
        working-directory: action-repo
        run: |
          # Get current date
          DATE=$(date -u +"%Y-%m-%d")
          
          # Create CHANGELOG if it doesn't exist
          if [ ! -f CHANGELOG.md ]; then
            cat > CHANGELOG.md << 'EOF'
          # Changelog
          
          All notable changes to this project will be documented in this file.
          
          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
          
          ## [Unreleased]
          
          ### Added
          EOF
          fi
          
          # Add new version entry
          VERSION="${{ steps.version.outputs.new }}"
          ENTRY="## [$VERSION] - $DATE\n### Changed\n- Automated sync from AI-Pulse repository\n- Updated workflow files and configurations\n"
          
          # Insert after "## [Unreleased]" section
          sed -i "/## \[Unreleased\]/a\\
          \\
          $ENTRY" CHANGELOG.md
          
          # Commit CHANGELOG update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG for $VERSION" || echo "No CHANGELOG changes"
          git push origin main

      - name: Create Release
        if: steps.commit.outputs.has_changes == 'true'
        working-directory: action-repo
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          gh release create ${{ steps.version.outputs.new }} \
            --title "Release ${{ steps.version.outputs.new }}" \
            --notes "Automated sync from AI-Pulse repository
          
          **Changes:**
          - Updated workflow and action files
          - Synced dependencies
          
          **Synced files:**
          - \`.github/workflows/dependabot-secure-flow.yaml\`
          - \`.github/workflows/release-notification.yaml\`
          - \`action.yml\`
          - \`.github/dependabot.yml\`" \
            --latest

      - name: Create summary
        run: |
          echo "âœ… Files synchronized to EthanThePhoenix38/dependabot-secure-flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files synced:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/workflows/dependabot-secure-flow.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/workflows/release-notification.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`action.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`.github/dependabot.yml\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.commit.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Release created:** ${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          fi
