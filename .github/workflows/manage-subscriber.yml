name: Manage subscriber

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  add-subscriber:
    if: github.event.label.name == 'subscription'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse and add subscriber
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;

            function getField(label) {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*(.+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            function getCheckboxes(label) {
              const regex = new RegExp(`### ${label}\\s*\\n([\\s\\S]*?)(?=###|$)`, 'i');
              const match = body.match(regex);
              if (!match) return [];
              return [...match[1].matchAll(/- \[X\] (.+)/gi)].map(m => m[1].trim());
            }

            // Validate email address format
            function isValidEmail(email) {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              return (
                typeof email === 'string' &&
                email.length > 0 &&
                email.length <= 254 &&
                emailRegex.test(email)
              );
            }

            // Basic abuse heuristic: ignore issues that appear to contain many email-like strings
            const atCount = (body.match(/@/g) || []).length;
            if (atCount > 5) {
              console.log('Suspicious issue body (too many @ symbols); skipping subscription.');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'This subscription request appears suspicious and has been rejected. If this is an error, please contact the maintainers.'
              });
              return;
            }

            const rawEmail = getField('Votre email / Your email');
            // In case multiple emails or extra text are provided, only keep the first token
            const email = rawEmail.split(/[,\s]+/).filter(Boolean)[0] || '';
            
            if (!isValidEmail(email)) {
              console.log('Invalid email:', rawEmail);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Invalid email address format: "${rawEmail}". Please provide a valid email address.`
              });
              return;
            }

            const selectedCats = getCheckboxes('Catégories souhaitées / Desired categories');
            const langRaw = getField('Langue préférée / Preferred language');
            const freqRaw = getField('Fréquence / Frequency');

            const catMap = {
              'AI / IA': 'ai',
              'Cybersecurity': 'cybersecurity',
              'IoT': 'iot',
              'Windows': 'windows',
              'Mac / Apple': 'mac',
              'Linux': 'linux',
              'Tech Générale': 'tech',
              'Entrepreneuriat': 'entrepreneurship',
              'Bourse & Finance': 'finance',
              'Crypto & Blockchain': 'crypto',
              'Open Source & GitHub': 'opensource',
              'Produits & Innovation': 'products'
            };

            const categories = selectedCats.map(c => catMap[c]).filter(Boolean);
            const lang = langRaw.includes('Français') ? 'fr' : langRaw.includes('English') ? 'en' : 'all';
            const frequency = freqRaw.includes('Quotidien') ? 'daily' : 'each_update';

            // Read subscribers
            const subsPath = 'data/subscribers.json';
            let subscribers = [];
            try {
              subscribers = JSON.parse(fs.readFileSync(subsPath, 'utf-8'));
            } catch (e) {
              subscribers = [];
            }

            // Check duplicate
            const exists = subscribers.some(s => s.email === email);
            if (exists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This email is already subscribed. To update preferences, please unsubscribe first and resubscribe.`
              });
              return;
            }

            // Add subscriber
            subscribers.push({
              email,
              categories: categories.length > 0 ? categories : Object.values(catMap),
              lang,
              frequency,
              subscribed_at: new Date().toISOString().split('T')[0]
            });

            fs.writeFileSync(subsPath, JSON.stringify(subscribers, null, 2));

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Welcome! You've been subscribed to AI-Pulse digest.\n\nCategories: ${categories.join(', ') || 'All'}\nLanguage: ${lang}\nFrequency: ${frequency}\n\nYou will receive your personalized digest at your next update cycle.`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

      - name: Commit changes
        run: |
          git config --global user.name 'PhoenixProject-AutoSync'
          git config --global user.email '${{ secrets.GIT_AUTHOR_EMAIL }}'
          git add data/subscribers.json
          if ! git diff --cached --exit-code; then
            git commit -m "Add subscriber from issue #${{ github.event.issue.number }}"
            git push
          fi
