# dummy change for sync verification
name: Release Notification

on:
  release:
    types: [published]

permissions:
  contents: read
  discussions: write

jobs:
  notify-release:
    runs-on: ubuntu-latest
    steps:
      - name: Create Release Announcement Discussion
        uses: actions/github-script@v7
        with:
          script: |
            const release = context.payload.release;
            
            const body = `## ðŸŽ‰ New Release: ${release.tag_name}
            
            A new version of **DependabotSecureFlow** has been published!
            
            ### ðŸ“¦ Release Details
            - **Version**: ${release.tag_name}
            - **Published**: ${new Date(release.published_at).toLocaleString()}
            - **Author**: @${release.author.login}
            
            ### ðŸ“ Release Notes
            ${release.body || 'No release notes provided.'}
            
            ### ðŸ”— Links
            - [View Release](${release.html_url})
            - [Download Assets](${release.html_url})
            - [Changelog](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CHANGELOG.md)
            
            ### ðŸ“¢ Update Instructions
            
            To use this version in your workflows, update your workflow file:
            
            \`\`\`yaml
            jobs:
              auto-merge-to-securite:
                uses: EthanThePhoenix38/dependabot-secure-flow/.github/workflows/dependabot-secure-flow.yml@${release.tag_name}
                secrets: inherit
            \`\`\`
            
            ---
            
            **Automated release notification** â€¢ [DependabotSecureFlow](https://github.com/EthanThePhoenix38/dependabot-secure-flow)
            `;
            
            // Get the Announcements category ID (you may need to adjust this)
            const categories = await github.rest.discussions.listCategories({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Find the Announcements category (or General if Announcements doesn't exist)
            const announcementCategory = categories.data.find(cat => 
              cat.name === 'Announcements' || cat.name === 'General'
            );
            
            if (!announcementCategory) {
              console.log('No suitable discussion category found. Skipping discussion creation.');
              return;
            }
            
            // Create a discussion instead of an issue
            await github.graphql(`
              mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
                createDiscussion(input: {
                  repositoryId: $repositoryId
                  categoryId: $categoryId
                  title: $title
                  body: $body
                }) {
                  discussion {
                    url
                  }
                }
              }
            `, {
              repositoryId: context.payload.repository.node_id,
              categoryId: announcementCategory.node_id,
              title: `ðŸ“¦ Release ${release.tag_name} Published`,
              body: body
            });

      - name: Send Summary
        run: |
          echo "## ðŸŽ‰ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL**: ${{ github.event.release.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A notification discussion has been created in the repository." >> $GITHUB_STEP_SUMMARY
