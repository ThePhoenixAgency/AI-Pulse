name: Auto-add approved source

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  add-source:
    if: github.event.label.name == 'source-approved'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse issue and add source
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;

            // Parse form fields from issue body
            function getField(label) {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*(.+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const sourceName = getField('Nom de la source / Source Name');
            const sourceUrl = getField('URL du site / Website URL');
            const rssUrl = getField('URL du flux RSS / RSS Feed URL');
            const categoryRaw = getField('Categorie / Category');
            const languageRaw = getField('Langue / Language');
            const tags = getField('Tags / Mots-cles');

            if (!sourceName || !rssUrl) {
              console.log('Missing required fields');
              return;
            }

            // Map category
            const catMap = {
              'AI / IA': 'ai',
              'Cybersecurity / Cybersecurite': 'cybersecurity',
              'IoT': 'iot',
              'Windows': 'windows',
              'Mac / Apple': 'mac',
              'Linux': 'linux',
              'Tech Generale': 'tech',
              'Entrepreneuriat / Entrepreneurship': 'entrepreneurship',
              'Bourse & Finance': 'finance',
              'Crypto & Blockchain': 'crypto',
              'Open Source & GitHub': 'opensource',
              'Produits & Innovation': 'products'
            };
            const category = catMap[categoryRaw] || 'tech';

            // Map language
            const lang = languageRaw.includes('Francais') ? 'fr' : 'en';

            // Parse tags
            const tagList = tags ? tags.split(',').map(t => t.trim()).filter(t => t) : [category];

            // Read and update config.json
            const config = JSON.parse(fs.readFileSync('config.json', 'utf-8'));
            if (!config.categories[category]) {
              console.log(`Category ${category} not found`);
              return;
            }

            // Check for duplicates
            const exists = config.categories[category].feeds.some(f => f.url === rssUrl);
            if (exists) {
              console.log('Source already exists');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This source (${rssUrl}) already exists in the ${category} category.`
              });
              return;
            }

            // Add new feed
            config.categories[category].feeds.push({
              name: sourceName,
              url: rssUrl,
              tags: tagList,
              lang: lang
            });

            fs.writeFileSync('config.json', JSON.stringify(config, null, 2));

            // Comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Source "${sourceName}" added to category "${category}" in config.json. It will be active at the next aggregation cycle.`
            });

            // Close issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

      - name: Commit changes
        run: |
          git config --global user.name 'PhoenixProject-AutoSync'
          git config --global user.email '${{ secrets.GIT_AUTHOR_EMAIL }}'
          git add config.json
          if ! git diff --cached --exit-code; then
            git commit -m "Add new source from issue #${{ github.event.issue.number }}"
            git push
          fi
