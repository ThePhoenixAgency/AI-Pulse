name: Auto-add approved source

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write

jobs:
  add-source:
    if: github.event.label.name == 'source-approved'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse issue and add source
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            const body = issue.body;

            // Constants
            const MAX_SOURCE_NAME_LENGTH = 100;
            const MAX_TAG_LENGTH = 50;

            // Parse form fields from issue body
            function getField(label) {
              const regex = new RegExp(`### ${label}\\s*\\n\\s*(.+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            const sourceName = getField('Nom de la source / Source Name');
            const sourceUrl = getField('URL du site / Website URL');
            const rssUrl = getField('URL du flux RSS / RSS Feed URL');
            const categoryRaw = getField('Catégorie / Category');
            const languageRaw = getField('Langue / Language');
            const tags = getField('Tags / Mots-cles');

            // Validate required fields
            if (!sourceName || !rssUrl) {
              console.log('Missing required fields');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Missing required fields (source name or RSS URL). Please provide all required information.'
              });
              return;
            }

            // Sanitize and validate source name (prevent injection)
            const sanitizedSourceName = sourceName.replace(/[<>'"]/g, '').slice(0, MAX_SOURCE_NAME_LENGTH);
            if (sanitizedSourceName !== sourceName) {
              console.log('Source name contains invalid characters');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Source name contains invalid characters. Please use only alphanumeric characters, spaces, and basic punctuation.'
              });
              return;
            }

            // Validate RSS URL format
            try {
              const urlObj = new URL(rssUrl);
              if (!['http:', 'https:'].includes(urlObj.protocol)) {
                throw new Error('Invalid protocol');
              }
            } catch (e) {
              console.log('Invalid RSS URL:', rssUrl);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Invalid RSS URL format: "${rssUrl}". Please provide a valid HTTP or HTTPS URL.`
              });
              return;
            }

            // Map category
            const catMap = {
              'AI / IA': 'ai',
              'Cybersecurity / Cybersécurité': 'cybersecurity',
              'IoT': 'iot',
              'Windows': 'windows',
              'Mac / Apple': 'mac',
              'Linux': 'linux',
              'Tech Générale': 'tech',
              'Entrepreneuriat / Entrepreneurship': 'entrepreneurship',
              'Bourse & Finance': 'finance',
              'Crypto & Blockchain': 'crypto',
              'Open Source & GitHub': 'opensource',
              'Produits & Innovation': 'products'
            };
            const category = catMap[categoryRaw] || 'tech';

            // Map language
            const lang = languageRaw.includes('Français') ? 'fr' : 'en';

            // Parse and sanitize tags
            const tagList = tags ? tags.split(',').map(t => t.trim().replace(/[<>'"]/g, '').slice(0, MAX_TAG_LENGTH)).filter(t => t) : [category];

            // Read and update config.json
            const config = JSON.parse(fs.readFileSync('config.json', 'utf-8'));
            if (!config.categories[category]) {
              console.log(`Category ${category} not found`);
              return;
            }

            // Check for duplicates
            const exists = config.categories[category].feeds.some(f => f.url === rssUrl);
            if (exists) {
              console.log('Source already exists');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `This source (${rssUrl}) already exists in the ${category} category.`
              });
              return;
            }

            // Add new feed with sanitized data
            config.categories[category].feeds.push({
              name: sanitizedSourceName,
              url: rssUrl,
              tags: tagList,
              lang: lang
            });

            fs.writeFileSync('config.json', JSON.stringify(config, null, 2));

            // Comment on issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Source "${sourceName}" added to category "${category}" in config.json. It will be active at the next aggregation cycle.`
            });

            // Close issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

      - name: Commit changes
        run: |
          git config --global user.name 'PhoenixProject-AutoSync'
          git config --global user.email '${{ secrets.GIT_AUTHOR_EMAIL }}'
          git add config.json
          if ! git diff --cached --exit-code; then
            git commit -m "Add new source from issue #${{ github.event.issue.number }}"
            git push
          fi
